---

- name: Extract Node and VM ID for VM {{ item }}
  set_fact:
    vm_id: "{{ proxmox_cluster_information.json.data | selectattr('name', 'equalto', item) | map(attribute='vmid') | first }}"
    vm_node: "{{ proxmox_cluster_information.json.data | selectattr('name', 'equalto', item) | map(attribute='node') | first }}"


- name: Get VM Status
  uri:
    method: GET
    validate_certs: no
    url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ vm_node }}/qemu/{{ vm_id }}/status/current"
    headers: "{{ proxmox_api_cookie }}"
  register: vm_status

- name: Start VM {{ item }}
  uri:
    method: POST
    validate_certs: no
    url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ vm_node }}/qemu/{{ vm_id }}/status/start"
    headers: "{{ proxmox_api_cookie }}"
    body_format: form-urlencoded
    body:
      timeout: "{{ boot_time }}"
  when: vm_status.json.data.status == 'stopped'

- name: Waiting for the VM to boot up
  pause: 
    seconds: "{{ boot_time }}"
  when: vm_status.json.data.status == 'stopped'

- name: Gather VM Facts
  gather_facts:
  register: vm_facts
  delegate_to: "{{ item }}"

- name: Update VM {{ item }} with apt
  apt:
    force_apt_get: yes
    name: "*"
    state: latest
    update_cache: yes
  become: yes
  delegate_to: "{{ item }}"
  when: vm_facts.ansible_facts.ansible_os_family == 'Debian'

- name: Update VM {{ item }} with yum
  yum:
    name: "*"
    state: latest
    update_cache: yes
  become: yes
  delegate_to: "{{ item }}"
  when: vm_facts.ansible_facts.ansible_os_family == 'RedHat'

- name: Shutdown VM {{ item }} when it was stopped before patching
  uri:
    method: POST
    validate_certs: no
    url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ vm_node }}/qemu/{{ vm_id }}/status/shutdown"
    headers: "{{ proxmox_api_cookie }}"
    body_format: form-urlencoded
    body:
      forceStop: 1
  when: vm_status.json.data.status == 'stopped'